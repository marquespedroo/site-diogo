<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Fluxo de Pagamento</title>
    <meta name="description" content="Calcule e planeje o fluxo de pagamento do seu im√≥vel com precis√£o">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .fade-in { animation: fadeIn 0.6s ease-out; }
        .slide-in { animation: slideIn 0.5s ease-out; }
        .float { animation: float 3s ease-in-out infinite; }
        .pulse { animation: pulse 2s ease-in-out infinite; }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        .input-glow:focus {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1),
                        0 0 30px rgba(99, 102, 241, 0.2);
        }
        
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .icon {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .icon-lg {
            width: 32px;
            height: 32px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .status-approved {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .status-rejected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Estilos para tooltips */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-icon {
            cursor: help;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-left: 6px;
        }
        
        .tooltip-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            width: 280px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #334155;
        }
        
        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            bottom: 130%;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute w-96 h-96 bg-white/10 rounded-full blur-3xl -top-48 -left-48 float"></div>
        <div class="absolute w-96 h-96 bg-white/10 rounded-full blur-3xl -bottom-48 -right-48" style="animation: float 4s ease-in-out infinite;"></div>
    </div>

    <div class="max-w-7xl mx-auto relative z-10">
        
        <div class="glass rounded-3xl shadow-2xl p-6 md:p-10 mb-8 fade-in card-hover">
            
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8 text-center md:text-left">
                <div class="p-4 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg float">
                    <svg class="icon icon-lg text-white" viewBox="0 0 24 24">
                        <rect x="4" y="2" width="16" height="20" rx="2"/>
                        <line x1="8" y1="6" x2="16" y2="6"/>
                        <line x1="8" y1="10" x2="16" y2="10"/>
                        <line x1="8" y1="14" x2="16" y2="14"/>
                        <line x1="8" y1="18" x2="12" y2="18"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-4xl md:text-5xl font-black gradient-text mb-2">Calculadora de Fluxo</h1>
                    <p class="text-gray-600 text-lg font-medium">Planeje seus pagamentos com intelig√™ncia e precis√£o</p>
                </div>
            </div>

            <div class="bg-gradient-to-r from-amber-400 via-orange-500 to-red-500 text-white rounded-2xl p-6 md:p-8 mb-8 shadow-xl slide-in relative overflow-hidden">
                <div class="absolute inset-0 shimmer opacity-20"></div>
                <h2 class="text-2xl md:text-3xl font-black mb-6 flex items-center gap-3 relative z-10">
                    <div class="p-2 bg-white/30 rounded-xl backdrop-blur-sm">
                        <svg class="icon text-white" viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    Informa√ß√µes da Obra e Capta√ß√£o
                </h2>
                <div class="grid md:grid-cols-3 gap-6 relative z-10">
                    <div class="bg-white/15 backdrop-blur-md rounded-xl p-5 hover:bg-white/25 transition-all card-hover">
                        <label for="mes-obra" class="block text-white text-sm mb-3 font-bold flex items-center gap-2">
                            <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            Data de Conclus√£o da Obra
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="mes-obra" class="px-4 py-3 border-0 rounded-xl focus:outline-none text-gray-800 font-bold shadow-lg input-glow transition-all" placeholder="M√™s" min="1" max="12" aria-label="M√™s de conclus√£o da obra"/>
                            <input type="number" id="ano-obra" class="px-4 py-3 border-0 rounded-xl focus:outline-none text-gray-800 font-bold shadow-lg input-glow transition-all" placeholder="Ano" min="2025" aria-label="Ano de conclus√£o da obra"/>
                        </div>
                    </div>
                    <div class="bg-white/15 backdrop-blur-md rounded-xl p-5 hover:bg-white/25 transition-all card-hover">
                        <label for="percentual-captacao" class="block text-white text-sm mb-3 font-bold flex items-center gap-2">
                            <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Capta√ß√£o (%)
                            <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">                                    
                                Percentual do valor total do im√≥vel que o cliente deve pagar √† construtora at√© a entrega do empreendimento. Pode incluir ou n√£o a parcela de Habite-se.
                                </div>
                            </div>
                        </label>
                        <input type="number" id="percentual-captacao" class="w-full px-4 py-3 border-0 rounded-xl focus:outline-none text-gray-800 font-bold shadow-lg input-glow transition-all" placeholder="0" step="0.01" aria-label="Percentual de capta√ß√£o necess√°rio"/>
                    </div>
                    <div id="info-meses" class="hidden items-center justify-center bg-white/15 backdrop-blur-md rounded-xl p-5 hover:bg-white/25 transition-all">
                        <div class="text-center">
                            <p class="text-white/90 text-sm mb-2 font-bold">Faltam</p>
                            <p class="text-6xl font-black pulse" id="meses-faltantes">0</p>
                            <p class="text-white/90 text-sm mt-2 font-bold" id="meses-label">meses</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-8 slide-in">
                <label for="valor-total" class="block text-xl font-black text-gray-800 mb-3 flex items-center gap-2">
                    <div class="p-2 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-md">
                        <svg class="icon w-6 h-6 text-white" viewBox="0 0 24 24">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                            <line x1="7" y1="7" x2="7.01" y2="7"/>
                        </svg>
                    </div>
                    Valor Total do Im√≥vel
                </label>
                <input type="text" id="valor-total" class="w-full px-6 py-4 border-0 rounded-2xl focus:outline-none text-3xl font-black text-gray-800 shadow-xl input-glow transition-all bg-gradient-to-r from-gray-50 to-gray-100 hover:shadow-2xl" placeholder="R$ 0,00" aria-label="Valor total do im√≥vel" aria-required="true"/>
            </div>

            <div id="entradas-section" class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 md:p-8 rounded-2xl mb-8 hidden shadow-xl fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-black text-gray-800 flex items-center gap-3">
                        <div class="p-2 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-md">
                            <svg class="icon w-6 h-6 text-white" viewBox="0 0 24 24">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                            </svg>
                        </div>
                        Entrada
                        <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">                                    
                            Adicione mais campos caso precise parcelar a entrada.
                                </div>
                            </div>
                    </h3>
                    <button id="btn-adicionar-entrada" class="flex items-center gap-2 px-5 py-3 btn-primary text-white rounded-xl shadow-lg font-bold" aria-label="Adicionar nova entrada">
                        <svg class="icon w-5 h-5" viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Adicionar
                    </button>
                </div>
                <div id="lista-entradas" class="space-y-4"></div>
            </div>

            <div id="durante-obra-section" class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 md:p-8 rounded-2xl mb-8 hidden shadow-xl fade-in">
                <h3 class="text-2xl font-black text-gray-800 mb-6 flex items-center gap-3">
                    <div class="p-2 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl shadow-md">
                        <svg class="icon w-6 h-6 text-white" viewBox="0 0 24 24">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                    </div>
                    Durante a Obra (<span id="durante-meses">0</span> meses)
                </h3>
                <div class="space-y-4" id="durante-obra-parcelas"></div>
            </div>

            <div id="habite-se-section" class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl mb-8 hidden shadow-xl fade-in">
                <div class="flex justify-between items-center mb-4">
                    <label for="parcela-habite-se" class="block text-xl font-black text-gray-800 flex items-center gap-2">
                        <div class="p-2 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl shadow-md">
                            <svg class="icon w-6 h-6 text-white" viewBox="0 0 24 24">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                        </div>
                        Habite-se
                        <div class="tooltip-container">
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">                                    
                            Valor √∫nico pago no momento da entrega do empreendimento, quando o im√≥vel est√° pronto e recebe a Carta de Habite-se.
                                </div>
                            </div>
                    </label>
                    <span id="habite-se-percentual" class="text-base font-black bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-xl hidden shadow-md">0%</span>
                </div>
                <input type="text" id="parcela-habite-se" class="w-full px-5 py-3 border-0 rounded-xl focus:outline-none font-bold text-xl shadow-lg input-glow transition-all bg-white" placeholder="R$ 0,00" aria-label="Valor da parcela do Habite-se"/>
            </div>

            <div id="pos-obra-section" class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 md:p-8 rounded-2xl hidden shadow-xl fade-in">
                <h3 class="text-2xl font-black text-gray-800 mb-6 flex items-center gap-3">
                    <div class="p-2 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-md">
                        <svg class="icon w-6 h-6 text-white" viewBox="0 0 24 24">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                    </div>
                    P√≥s-Obra
                </h3>
                <div class="space-y-4" id="pos-obra-parcelas"></div>
            </div>
        </div>

        <div id="resultados-section" class="glass rounded-3xl shadow-2xl p-8 md:p-10 hidden fade-in">
            <h2 class="text-4xl font-black gradient-text mb-8 flex items-center gap-3">
                <div class="p-3 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg">
                    <svg class="icon icon-lg text-white" viewBox="0 0 24 24">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                </div>
                An√°lise do Fluxo
            </h2>

            <div id="status-aprovacao" class="p-8 rounded-2xl mb-8 shadow-2xl transition-all relative overflow-hidden">
                <div class="absolute inset-0 shimmer opacity-10"></div>
                <div class="flex items-center gap-4 mb-6 relative z-10">
                    <div class="p-3 rounded-xl shadow-lg">
                        <svg id="status-icon" class="icon icon-lg" viewBox="0 0 24 24"></svg>
                    </div>
                    <h3 id="status-texto" class="text-4xl font-black"></h3>
                </div>
                <div class="space-y-4" id="status-detalhes"></div>
            </div>

            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 md:p-8 shadow-xl">
                <h3 class="text-2xl font-black text-gray-800 mb-6 flex items-center gap-2">
                    <svg class="icon text-indigo-600" viewBox="0 0 24 24">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    Resumo Financeiro
                </h3>
                <div class="space-y-4" id="resumo-valores"></div>
            </div>
        </div>
    </div>

    <script>
        const state = {
            valorTotal: 0,
            entradas: [{ id: 1, valor: 0, qtd: 1 }],
            parcelasDuranteObra: {
                mensais: { valor: 0, qtd: 0 },
                semestrais: { valor: 0, qtd: 0 },
                anuais: { valor: 0, qtd: 0 }
            },
            parcelaHabiteSe: 0,
            parcelasPosObra: {
                mensais: { valor: 0, qtd: 0 },
                semestrais: { valor: 0, qtd: 0 },
                anuais: { valor: 0, qtd: 0 }
            },
            percentualCaptacao: 0,
            mesObra: null,
            anoObra: null
        };

        function formatCurrency(value) {
            if (!value && value !== 0) return '';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(value);
        }

        function parseCurrency(str) {
            if (typeof str === 'number') return str;
            return parseFloat(str.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        }

        function handleCurrencyInput(e) {
            const numbers = e.target.value.replace(/\D/g, '');
            const value = numbers ? parseFloat(numbers) / 100 : 0;
            e.target.value = value ? formatCurrency(value) : '';
            return value;
        }

        function calcularInfoObra() {
            if (!state.mesObra || !state.anoObra) return null;
            
            const hoje = new Date();
            const dataObra = new Date(parseInt(state.anoObra), parseInt(state.mesObra) - 1);
            const meses = Math.max(0, (dataObra.getFullYear() - hoje.getFullYear()) * 12 + (dataObra.getMonth() - hoje.getMonth()));
            
            return {
                meses,
                maxSemestrais: Math.floor(meses / 6),
                maxAnuais: Math.floor(meses / 12)
            };
        }

        function calcularPercentual(valor, qtd) {
            if (state.valorTotal === 0) return '0.00';
            return (((valor * qtd) / state.valorTotal) * 100).toFixed(2);
        }

        function criarCampoParcela(id, label, tipo, maxQtd = null) {
            const uniqueId = `${tipo}-${id}-${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'bg-white p-6 rounded-xl border-2 border-gray-200 shadow-lg hover:shadow-2xl transition-all card-hover';
            div.dataset.parcelaId = id;
            div.dataset.parcelaTipo = tipo;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-black text-gray-800 text-lg">${label}</h4>
                    <div class="flex items-center gap-3">
                        <span class="info-valor text-sm text-gray-600 font-bold hidden"></span>
                        <span class="info-percentual text-sm font-black bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-3 py-1 rounded-lg hidden shadow-md">0%</span>
                        ${tipo === 'entrada' ? '<button class="btn-remover text-red-600 hover:text-red-800 hover:scale-125 transition-all hidden" aria-label="Remover entrada"><svg class="icon w-6 h-6" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>' : ''}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="valor-${uniqueId}" class="block text-xs font-black text-gray-600 mb-2 flex items-center gap-1">
                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Valor
                        </label>
                        <input type="text" id="valor-${uniqueId}" class="input-valor w-full px-4 py-3 border-0 bg-gray-50 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-300 focus:outline-none font-bold transition-all shadow-md" placeholder="R$ 0,00" aria-label="Valor da parcela ${label}"/>
                    </div>
                    <div>
                        <label for="qtd-${uniqueId}" class="block text-xs font-black text-gray-600 mb-2 flex items-center gap-1">
                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"/>
                                <line x1="8" y1="12" x2="21" y2="12"/>
                                <line x1="8" y1="18" x2="21" y2="18"/>
                                <line x1="3" y1="6" x2="3.01" y2="6"/>
                                <line x1="3" y1="12" x2="3.01" y2="12"/>
                                <line x1="3" y1="18" x2="3.01" y2="18"/>
                            </svg>
                            Quantidade
                        </label>
                        <input type="number" id="qtd-${uniqueId}" class="input-qtd w-full px-4 py-3 border-0 bg-gray-50 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-300 focus:outline-none font-bold transition-all shadow-md" placeholder="0" min="1" ${maxQtd ? `max="${maxQtd}"` : ''} aria-label="Quantidade de parcelas ${label}"/>
                    </div>
                </div>
            `;
            
            const inputValor = div.querySelector('.input-valor');
            const inputQtd = div.querySelector('.input-qtd');
            
            inputValor.addEventListener('input', (e) => {
                const valor = handleCurrencyInput(e);
                atualizarParcela(id, tipo, 'valor', valor);
            });
            
            inputQtd.addEventListener('input', (e) => {
                const qtd = parseInt(e.target.value) || 0;
                atualizarParcela(id, tipo, 'qtd', qtd);
            });
            
            if (tipo === 'entrada') {
                const btnRemover = div.querySelector('.btn-remover');
                btnRemover.addEventListener('click', () => removerEntrada(id));
            }
            
            return div;
        }

        function atualizarParcela(id, tipo, campo, valor) {
            if (tipo === 'entrada') {
                const entrada = state.entradas.find(e => e.id === id);
                if (entrada) entrada[campo] = valor;
            } else if (tipo.startsWith('durante-')) {
                const periodo = tipo.replace('durante-', '');
                state.parcelasDuranteObra[periodo][campo] = valor;
            } else if (tipo.startsWith('pos-')) {
                const periodo = tipo.replace('pos-', '');
                state.parcelasPosObra[periodo][campo] = valor;
            }
            
            calcularResultados();
        }

        function adicionarEntrada() {
            const novaEntrada = {
                id: Date.now(),
                valor: 0,
                qtd: 1
            };
            state.entradas.push(novaEntrada);
            renderizarEntradas();
        }

        function removerEntrada(id) {
            if (state.entradas.length > 1) {
                state.entradas = state.entradas.filter(e => e.id !== id);
                renderizarEntradas();
                calcularResultados();
            }
        }

        function renderizarEntradas() {
            const container = document.getElementById('lista-entradas');
            
            // Salvar valores atuais antes de limpar
            const valoresAtuais = {};
            document.querySelectorAll('#lista-entradas .bg-white').forEach((campo, index) => {
                const entrada = state.entradas[index];
                if (entrada) {
                    const inputValor = campo.querySelector('.input-valor');
                    const inputQtd = campo.querySelector('.input-qtd');
                    valoresAtuais[entrada.id] = {
                        valorFormatado: inputValor.value,
                        qtd: inputQtd.value
                    };
                }
            });
            
            container.innerHTML = '';
            
            state.entradas.forEach((entrada, index) => {
                const campo = criarCampoParcela(entrada.id, `Entrada ${index + 1}`, 'entrada');
                const inputValor = campo.querySelector('.input-valor');
                const inputQtd = campo.querySelector('.input-qtd');
                
                // Restaurar valores salvos ou usar valores do state
                if (valoresAtuais[entrada.id]) {
                    inputValor.value = valoresAtuais[entrada.id].valorFormatado;
                    inputQtd.value = valoresAtuais[entrada.id].qtd;
                } else {
                    if (entrada.valor) inputValor.value = formatCurrency(entrada.valor);
                    if (entrada.qtd) inputQtd.value = entrada.qtd;
                }
                
                if (state.entradas.length > 1) {
                    campo.querySelector('.btn-remover').classList.remove('hidden');
                }
                
                container.appendChild(campo);
            });
        }

        function renderizarParcelasDuranteObra(infoObra) {
            const container = document.getElementById('durante-obra-parcelas');
            container.innerHTML = '';
            
            if (infoObra.meses > 0) {
                const mensais = criarCampoParcela('mensais', `Mensais (m√°x ${infoObra.meses})`, 'durante-mensais', infoObra.meses);
                container.appendChild(mensais);
            }
            
            if (infoObra.maxSemestrais > 0) {
                const semestrais = criarCampoParcela('semestrais', `Semestrais (m√°x ${infoObra.maxSemestrais})`, 'durante-semestrais', infoObra.maxSemestrais);
                container.appendChild(semestrais);
            }
            
            if (infoObra.maxAnuais > 0) {
                const anuais = criarCampoParcela('anuais', `Anuais (m√°x ${infoObra.maxAnuais})`, 'durante-anuais', infoObra.maxAnuais);
                container.appendChild(anuais);
            }
        }

        function renderizarParcelasPosObra() {
            const container = document.getElementById('pos-obra-parcelas');
            container.innerHTML = '';
            
            const mensais = criarCampoParcela('mensais', 'Mensais', 'pos-mensais');
            const semestrais = criarCampoParcela('semestrais', 'Semestrais', 'pos-semestrais');
            const anuais = criarCampoParcela('anuais', 'Anuais', 'pos-anuais');
            
            container.appendChild(mensais);
            container.appendChild(semestrais);
            container.appendChild(anuais);
        }

        function calcularResultados() {
            if (state.valorTotal === 0) {
                document.getElementById('resultados-section').classList.add('hidden');
                return;
            }

            const totalEntradas = state.entradas.reduce((acc, e) => acc + (e.valor * e.qtd), 0);
            const totalDurante = Object.values(state.parcelasDuranteObra).reduce((acc, p) => acc + (p.valor * p.qtd), 0);
            const totalPosObra = Object.values(state.parcelasPosObra).reduce((acc, p) => acc + (p.valor * p.qtd), 0);
            const valorDuranteObra = totalEntradas + totalDurante + state.parcelaHabiteSe;
            const totalPago = valorDuranteObra + totalPosObra;
            const valorFaltanteExcedente = state.valorTotal - totalPago;
            const valorCaptacaoNecessario = (state.valorTotal * state.percentualCaptacao) / 100;
            const diferencaCaptacao = valorDuranteObra - valorCaptacaoNecessario;
            const aprovado = valorDuranteObra >= valorCaptacaoNecessario;
            const percentualPagoDuranteObra = (valorDuranteObra / state.valorTotal) * 100;
            const percentualPagoTotal = (totalPago / state.valorTotal) * 100;

            const statusDiv = document.getElementById('status-aprovacao');
            const statusIcon = document.getElementById('status-icon');
            const statusTexto = document.getElementById('status-texto');
            const statusDetalhes = document.getElementById('status-detalhes');

            if (aprovado) {
                statusDiv.className = 'p-8 rounded-2xl mb-8 shadow-2xl transition-all relative overflow-hidden status-approved';
                statusDiv.setAttribute('role', 'alert');
                statusDiv.setAttribute('aria-live', 'polite');
                statusIcon.innerHTML = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>';
                statusIcon.parentElement.className = 'p-3 rounded-xl shadow-lg bg-white/20 backdrop-blur-sm';
                statusIcon.className = 'icon icon-lg text-white pulse';
                statusTexto.textContent = 'APROVADO ‚úì';
                statusTexto.className = 'text-4xl font-black text-white';
            } else {
                statusDiv.className = 'p-8 rounded-2xl mb-8 shadow-2xl transition-all relative overflow-hidden status-rejected';
                statusDiv.setAttribute('role', 'alert');
                statusDiv.setAttribute('aria-live', 'polite');
                statusIcon.innerHTML = '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>';
                statusIcon.parentElement.className = 'p-3 rounded-xl shadow-lg bg-white/20 backdrop-blur-sm';
                statusIcon.className = 'icon icon-lg text-white pulse';
                statusTexto.textContent = 'REPROVADO ‚úó';
                statusTexto.className = 'text-4xl font-black text-white';
            }

            statusDetalhes.innerHTML = `
                <div class="bg-white/20 backdrop-blur-md rounded-xl p-6 mb-3 shadow-lg relative z-10">
                    <p class="text-white font-bold text-lg">
                        <span class="text-white/90">üí∞ Capta√ß√£o necess√°ria:</span> 
                        <span class="float-right">${formatCurrency(valorCaptacaoNecessario)} <span class="text-white/80 text-sm">(${state.percentualCaptacao.toFixed(2)}%)</span></span>
                    </p>
                </div>
                <div class="bg-white/20 backdrop-blur-md rounded-xl p-6 mb-3 shadow-lg relative z-10">
                    <p class="text-white font-bold text-lg">
                        <span class="text-white/90">üèóÔ∏è Pago durante obra:</span> 
                        <span class="float-right">${formatCurrency(valorDuranteObra)} <span class="text-white/80 text-sm">(${percentualPagoDuranteObra.toFixed(2)}%)</span></span>
                    </p>
                </div>
                <div class="bg-white/30 backdrop-blur-md rounded-xl p-6 shadow-xl relative z-10">
                    <p class="text-white font-black text-lg">
                        <span class="text-xl">üìä Diferen√ßa:</span> 
                        <span class="float-right text-xl">${formatCurrency(Math.abs(diferencaCaptacao))} 
                        ${aprovado ? '‚ú® (excedente)' : '‚ö†Ô∏è (faltante)'}</span>
                    </p>
                </div>
            `;

            const resumoValores = document.getElementById('resumo-valores');
            const corFaltante = valorFaltanteExcedente < 0 ? 'from-red-500 to-pink-600' : valorFaltanteExcedente > 0 ? 'from-orange-500 to-red-500' : 'from-green-500 to-emerald-600';
            
            resumoValores.innerHTML = `
                <div class="flex justify-between items-center py-5 border-b-2 border-gray-300 hover:bg-gray-50 transition-all rounded-lg px-4">
                    <span class="font-bold text-gray-700 flex items-center gap-2 text-lg">
                        <svg class="icon w-5 h-5 text-gray-500" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Valor Total
                    </span>
                    <span class="font-black text-2xl text-gray-900">${formatCurrency(state.valorTotal)}</span>
                </div>
                <div class="flex justify-between items-center py-5 border-b-2 border-gray-300 hover:bg-blue-50 transition-all rounded-lg px-4">
                    <span class="font-bold text-gray-700 flex items-center gap-2 text-lg">
                        <svg class="icon w-5 h-5 text-blue-500" viewBox="0 0 24 24">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                        Saldo (Durante Obra)
                    </span>
                    <div class="text-right">
                        <span class="font-black text-2xl text-blue-700">${formatCurrency(valorDuranteObra)}</span>
                        <span class="block text-sm text-blue-600 font-bold">${percentualPagoDuranteObra.toFixed(2)}%</span>
                    </div>
                </div>
                <div class="flex justify-between items-center py-5 border-b-2 border-gray-300 hover:bg-green-50 transition-all rounded-lg px-4">
                    <span class="font-bold text-gray-700 flex items-center gap-2 text-lg">
                        <svg class="icon w-5 h-5 text-green-500" viewBox="0 0 24 24">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                        Saldo (P√≥s-Obra)
                    </span>
                    <div class="text-right">
                        <span class="font-black text-2xl text-green-700">${formatCurrency(totalPosObra)}</span>
                        <span class="block text-sm text-green-600 font-bold">${((totalPosObra / state.valorTotal) * 100).toFixed(2)}%</span>
                    </div>
                </div>
                <div class="flex justify-between items-center py-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl px-6 shadow-md mb-4">
                    <span class="font-black text-gray-800 text-xl flex items-center gap-2">
                        <svg class="icon w-6 h-6 text-indigo-600" viewBox="0 0 24 24">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                        Total Pago
                    </span>
                    <div class="text-right">
                        <span class="font-black text-3xl gradient-text">${formatCurrency(totalPago)}</span>
                        <span class="block text-sm text-indigo-600 font-black">${percentualPagoTotal.toFixed(2)}%</span>
                    </div>
                </div>
                <div class="flex justify-between items-center py-6 bg-gradient-to-r ${corFaltante} rounded-xl px-6 shadow-xl">
                    <span class="font-black text-white text-xl flex items-center gap-2">
                        ${valorFaltanteExcedente < 0 ? 'üìà Valor Excedente' : valorFaltanteExcedente > 0 ? '‚ö†Ô∏è Valor Faltante' : '‚úÖ Pagamento Completo'}
                    </span>
                    ${valorFaltanteExcedente !== 0 ? `
                        <div class="text-right">
                            <div class="font-black text-3xl text-white">${formatCurrency(Math.abs(valorFaltanteExcedente))}</div>
                            <div class="font-bold text-white/90 text-sm">${((Math.abs(valorFaltanteExcedente) / state.valorTotal) * 100).toFixed(2)}%</div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('resultados-section').classList.remove('hidden');
            atualizarPercentuais();
        }

        function atualizarPercentuais() {
            document.querySelectorAll('#lista-entradas .bg-white').forEach((campo, index) => {
                const entrada = state.entradas[index];
                if (entrada && entrada.valor && entrada.qtd) {
                    const total = entrada.valor * entrada.qtd;
                    const perc = calcularPercentual(entrada.valor, entrada.qtd);
                    campo.querySelector('.info-valor').textContent = formatCurrency(total);
                    campo.querySelector('.info-valor').classList.remove('hidden');
                    campo.querySelector('.info-percentual').textContent = `${perc}%`;
                    campo.querySelector('.info-percentual').classList.remove('hidden');
                } else {
                    campo.querySelector('.info-valor').classList.add('hidden');
                    campo.querySelector('.info-percentual').classList.add('hidden');
                }
            });

            const habiteSePerc = document.getElementById('habite-se-percentual');
            if (state.parcelaHabiteSe && state.valorTotal) {
                habiteSePerc.textContent = `${calcularPercentual(state.parcelaHabiteSe, 1)}%`;
                habiteSePerc.classList.remove('hidden');
            } else {
                habiteSePerc.classList.add('hidden');
            }
            
            document.querySelectorAll('#durante-obra-parcelas .bg-white, #pos-obra-parcelas .bg-white').forEach((campo) => {
                const inputValor = campo.querySelector('.input-valor');
                const inputQtd = campo.querySelector('.input-qtd');
                const infoValor = campo.querySelector('.info-valor');
                const infoPercentual = campo.querySelector('.info-percentual');
                
                const valor = parseCurrency(inputValor.value);
                const qtd = parseInt(inputQtd.value) || 0;
                
                if (valor && qtd) {
                    const total = valor * qtd;
                    const perc = calcularPercentual(valor, qtd);
                    infoValor.textContent = formatCurrency(total);
                    infoValor.classList.remove('hidden');
                    infoPercentual.textContent = `${perc}%`;
                    infoPercentual.classList.remove('hidden');
                } else {
                    infoValor.classList.add('hidden');
                    infoPercentual.classList.add('hidden');
                }
            });
        }

        function atualizarInfoObra() {
            const infoObra = calcularInfoObra();
            
            if (infoObra) {
                document.getElementById('info-meses').classList.remove('hidden');
                document.getElementById('info-meses').classList.add('flex');
                document.getElementById('meses-faltantes').textContent = infoObra.meses;
                document.getElementById('meses-label').textContent = infoObra.meses === 1 ? 'm√™s' : 'meses';
                document.getElementById('durante-meses').textContent = infoObra.meses;
                
                document.getElementById('entradas-section').classList.remove('hidden');
                document.getElementById('durante-obra-section').classList.remove('hidden');
                document.getElementById('habite-se-section').classList.remove('hidden');
                document.getElementById('pos-obra-section').classList.remove('hidden');
                
                renderizarEntradas();
                renderizarParcelasDuranteObra(infoObra);
                renderizarParcelasPosObra();
                calcularResultados();
            } else {
                document.getElementById('info-meses').classList.add('hidden');
                document.getElementById('entradas-section').classList.add('hidden');
                document.getElementById('durante-obra-section').classList.add('hidden');
                document.getElementById('habite-se-section').classList.add('hidden');
                document.getElementById('pos-obra-section').classList.add('hidden');
                document.getElementById('resultados-section').classList.add('hidden');
            }
        }

        document.getElementById('valor-total').addEventListener('input', (e) => {
            state.valorTotal = handleCurrencyInput(e);
            calcularResultados();
        });

        document.getElementById('mes-obra').addEventListener('input', (e) => {
            state.mesObra = e.target.value;
            atualizarInfoObra();
        });

        document.getElementById('ano-obra').addEventListener('input', (e) => {
            state.anoObra = e.target.value;
            atualizarInfoObra();
        });

        document.getElementById('percentual-captacao').addEventListener('input', (e) => {
            state.percentualCaptacao = parseFloat(e.target.value) || 0;
            calcularResultados();
        });

        document.getElementById('parcela-habite-se').addEventListener('input', (e) => {
            state.parcelaHabiteSe = handleCurrencyInput(e);
            calcularResultados();
        });

        document.getElementById('btn-adicionar-entrada').addEventListener('click', adicionarEntrada);

        renderizarEntradas();
    </script>
</body>
</html>